<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliações Periódicas - Lumicenter Feedback</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0d556d 0%, #0a4555 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0d556d 0%, #0a4555 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border: 1px solid rgb(255, 255, 255);
            border-radius: 15px 15px 0px 0px;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e1e5e9;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #6c757d;
        }

        .tab.active {
            color: #0d556d;
            border-bottom-color: #0d556d;
            background: white;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .content {
            padding: 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #0d556d;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0d556d 0%, #0a4555 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(13, 85, 109, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-outline-primary {
            background: transparent;
            color: #0d556d;
            border: 2px solid #0d556d;
        }

        .btn-outline-primary:hover,
        .btn-outline-primary.active {
            background: #0d556d;
            color: white;
        }

        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 2px solid #6c757d;
        }

        .btn-outline-secondary:hover,
        .btn-outline-secondary.active {
            background: #6c757d;
            color: white;
        }
        
        .btn-outline-warning {
            background: transparent;
            color: #ed8936;
            border: 2px solid #ed8936;
        }
        
        .btn-outline-warning:hover {
            background: #ed8936;
            color: white;
        }

        /* Estilos para select pesquisável */
        .searchable-select {
            position: relative;
            width: 100%;
        }
        
        .searchable-select input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            cursor: pointer;
        }
        
        .searchable-select input:focus {
            outline: none;
            border-color: #0d556d;
            cursor: text;
        }
        
        .select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e1e5e9;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .select-dropdown.show {
            display: block;
        }
        
        .select-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
        }
        
        .select-option:hover {
            background-color: #f8f9fa;
        }
        
        .select-option:last-child {
            border-bottom: none;
        }
        
        .select-option.selected {
            background-color: #0d556d;
            color: white;
        }

        .template-options {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e1e5e9;
        }

        .template-options h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .template-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .template-content {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        /* Estilos específicos para os templates */
        #template-padrao {
            display: block !important;
        }
        
        #template-personalizado {
            display: none !important;
        }
        
        .template-content#template-padrao {
            display: block !important;
        }
        
        .template-content#template-personalizado {
            display: none !important;
        }
        
        /* Garantir que o template padrão seja sempre visível inicialmente */
        body .template-content#template-padrao {
            display: block !important;
        }
        
        body .template-content#template-personalizado {
            display: none !important;
        }
        
        /* Estilos de debug para verificar se os templates estão funcionando */
        .template-content {
            transition: all 0.3s ease;
        }
        
        .template-content[style*="display: none"] {
            opacity: 0;
            pointer-events: none;
        }
        
        .template-content[style*="display: block"] {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Forçar visibilidade do template padrão */
        .template-content#template-padrao {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Estilos de debug para verificar se os templates estão funcionando */
        .template-content {
            transition: all 0.3s ease;
        }
        
        .template-content[style*="display: none"] {
            opacity: 0;
            pointer-events: none;
        }
        
        .template-content[style*="display: block"] {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Garantir que o template padrão seja sempre visível */
        .template-content#template-padrao {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        /* Garantir que o template personalizado seja sempre escondido inicialmente */
        .template-content#template-personalizado {
            display: none !important;
        }
        
        /* Estilos para prévia das perguntas do template */
        .perguntas-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }
        
        .perguntas-preview h5 {
            color: #0d556d;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .perguntas-lista {
            margin-top: 15px;
        }
        
        .categoria-perguntas {
            margin-bottom: 20px;
        }
        
        .categoria-perguntas h6 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1rem;
            border-bottom: 2px solid #0d556d;
            padding-bottom: 5px;
        }
        
        .pergunta-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 4px solid #0d556d;
        }
        
        .pergunta-numero {
            background: #0d556d;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .pergunta-texto {
            color: #4a5568;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        /* Estilos para o editor de template */
        .perguntas-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .text-muted {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .editor-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e1e5e9;
        }
        
        .pergunta-editavel {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .pergunta-editavel:hover {
            border-color: #0d556d;
        }
        
        .pergunta-editavel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .pergunta-editavel-numero {
            background: #0d556d;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .pergunta-editavel-categoria {
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
        }
        
        .pergunta-editavel-texto {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            font-size: 0.9rem;
            line-height: 1.4;
            resize: vertical;
        }
        
        .pergunta-editavel-texto:focus {
            outline: none;
            border-color: #0d556d;
            box-shadow: 0 0 0 2px rgba(13, 85, 109, 0.1);
        }
        
        .template-status {
            font-size: 0.8rem;
            font-weight: normal;
            margin-left: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .template-status.editado {
            background: #fef5e7;
            color: #744210;
        }

        .template-info {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #0d556d;
        }

        .template-info h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .template-info p {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .categorias-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .categoria-preview {
            background: white;
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            text-align: center;
            font-size: 14px;
        }

        .pergunta-item {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .pergunta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pergunta-numero {
            background: #0d556d;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .remover-pergunta {
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .remover-pergunta:hover {
            background: #e53e3e;
        }

        .avaliacoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .avaliacao-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .avaliacao-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .avaliacao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .avaliacao-tipo {
            background: #0d556d;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .avaliacao-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pendente {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-autoavaliacao {
            background: #fef5e7;
            color: #744210;
        }

        .status-concluida {
            background: #c6f6d5;
            color: #22543d;
        }

        .avaliacao-info {
            margin-bottom: 20px;
        }

        .avaliacao-info h4 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .avaliacao-info p {
            color: #6c757d;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .avaliacao-actions {
            display: flex;
            gap: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d556d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
            
            .avaliacoes-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-star"></i> Sistema de Avaliações Periódicas</h1>
            <p>Avaliações de 45 e 90 dias para colaboradores</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('gestor')">
                <i class="fas fa-user-tie"></i> Gestor
            </div>
            <div class="tab" onclick="showTab('colaborador')">
                <i class="fas fa-user"></i> Colaborador
            </div>
        </div>

        <div class="content">
            <!-- TAB GESTOR -->
            <div id="tab-gestor" class="tab-content active">
                <div class="error-message" id="errorMessageGestor"></div>
                <div class="success-message" id="successMessageGestor"></div>

                                 <h2><i class="fas fa-plus-circle"></i> Criar Nova Avaliação</h2>
                 
                 <div class="template-options">
                     <h3><i class="fas fa-list-check"></i> Escolha o Template</h3>
                     <div class="template-buttons">
                         <button type="button" class="btn btn-outline-primary active" onclick="selecionarTemplate('padrao', event)">
                             <i class="fas fa-star"></i> Template Padrão (45/90 dias)
                         </button>
                         <button type="button" class="btn btn-outline-secondary" onclick="selecionarTemplate('personalizado', event)">
                             <i class="fas fa-edit"></i> Avaliação Personalizada
                         </button>
                     </div>
                     <div style="margin-top: 15px;">
                         <button type="button" class="btn btn-outline-warning" onclick="testarTemplates()">
                             <i class="fas fa-bug"></i> Testar Templates
                         </button>
                     </div>
                 </div>

                 <!-- Template Padrão -->
                 <div id="template-padrao" class="template-content" style="display: block !important;">
                     <div class="template-info">
                         <h4><i class="fas fa-info-circle"></i> Template de Avaliação de Experiência (45/90 dias)</h4>
                         <p>Este template inclui 10 perguntas organizadas em 4 categorias: Integração, Adaptação, Valores e Orientação para Resultados.</p>
                         
                         <div class="categorias-preview">
                             <div class="categoria-preview">
                                 <strong>Integração:</strong> 1 pergunta
                             </div>
                             <div class="categoria-preview">
                                 <strong>Adaptação:</strong> 3 perguntas
                             </div>
                             <div class="categoria-preview">
                                 <strong>Valores:</strong> 3 perguntas
                             </div>
                             <div class="categoria-preview">
                                 <strong>Orientação para Resultados:</strong> 3 perguntas
                             </div>
                         </div>
                         
                         <div class="perguntas-preview">
                             <h5>
                                 <i class="fas fa-eye"></i> Prévia das Perguntas do Template
                                 <span id="templateStatus" class="template-status"></span>
                             </h5>
                             <div class="perguntas-actions">
                                 <button type="button" class="btn btn-outline-primary btn-sm" onclick="mostrarPerguntasTemplate()">
                                     <i class="fas fa-eye"></i> Ver Perguntas do Template
                                 </button>
                                 <button type="button" class="btn btn-outline-warning btn-sm" onclick="editarTemplatePadrao()">
                                     <i class="fas fa-edit"></i> Editar Template
                                 </button>
                                 <button type="button" class="btn btn-outline-danger btn-sm" onclick="restaurarTemplateOriginal()" title="Restaurar template original">
                                     <i class="fas fa-undo"></i> Restaurar Original
                                 </button>
                             </div>
                             
                             <div id="perguntasTemplatePreview" style="display: none;">
                                 <div class="perguntas-lista">
                                     <div class="categoria-perguntas">
                                         <h6><i class="fas fa-handshake"></i> Integração</h6>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">1.</span>
                                             <span class="pergunta-texto">É acessível e acolhedor com todas as pessoas, tratando a todos com respeito e cordialidade.</span>
                                         </div>
                                     </div>
                                     
                                     <div class="categoria-perguntas">
                                         <h6><i class="fas fa-sync-alt"></i> Adaptação</h6>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">2.</span>
                                             <span class="pergunta-texto">É pontual no cumprimento de sua jornada de trabalho (faltas, atrasos ou saídas antecipadas).</span>
                                         </div>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">3.</span>
                                             <span class="pergunta-texto">Identifica oportunidades que contribuam para o desenvolvimento do Setor.</span>
                                         </div>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">4.</span>
                                             <span class="pergunta-texto">Mantém a calma frente a diversidade do ambiente e à novos desafios, buscando interagir de forma adequada às mudanças.</span>
                                         </div>
                                     </div>
                                     
                                     <div class="categoria-perguntas">
                                         <h6><i class="fas fa-heart"></i> Valores</h6>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">5.</span>
                                             <span class="pergunta-texto">É respeitoso com as pessoas contribuindo com um ambiente de trabalho saudável.</span>
                                         </div>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">6.</span>
                                             <span class="pergunta-texto">Tem caráter inquestionável, age com honestidade e integridade no relacionamento com gestores, colegas, prestadores de serviço, fornecedores e demais profissionais que venha a ter contato na empresa.</span>
                                         </div>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">7.</span>
                                             <span class="pergunta-texto">Exerce suas atividades com transparência e estrita observância às leis, aos princípios e as diretrizes da empresa.</span>
                                         </div>
                                     </div>
                                     
                                     <div class="categoria-perguntas">
                                         <h6><i class="fas fa-target"></i> Orientação para Resultados</h6>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">8.</span>
                                             <span class="pergunta-texto">Mantém a produtividade e a motivação diante de situações sobre pressão.</span>
                                         </div>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">9.</span>
                                             <span class="pergunta-texto">Age com engajamento para atingir os objetivos e metas.</span>
                                         </div>
                                         <div class="pergunta-item">
                                             <span class="pergunta-numero">10.</span>
                                             <span class="pergunta-texto">Capacidade para concretizar as tarefas que lhe são solicitadas, com o alcance de objetivos e de forma comprometida com o resultado de seu Setor.</span>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             
                             <!-- Editor de Template Padrão -->
                             <div id="editorTemplatePadrao" style="display: none;">
                                 <h6><i class="fas fa-edit"></i> Editor de Template</h6>
                                 <p class="text-muted">Edite as perguntas do template padrão conforme necessário:</p>
                                 
                                 <div id="perguntasEditaveis">
                                     <!-- As perguntas editáveis serão inseridas aqui via JavaScript -->
                                 </div>
                                 
                                 <div class="editor-actions">
                                     <button type="button" class="btn btn-success btn-sm" onclick="salvarTemplateEditado()">
                                         <i class="fas fa-save"></i> Salvar Template Editado
                                     </button>
                                     <button type="button" class="btn btn-secondary btn-sm" onclick="cancelarEdicaoTemplate()">
                                         <i class="fas fa-times"></i> Cancelar
                                     </button>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     <form id="formCriarAvaliacao">
                                                   <div class="form-row">
                              <div class="form-group">
                                  <label for="colaborador">Colaborador *</label>
                                  <div class="searchable-select">
                                      <input type="text" class="form-input" id="colaborador-search" placeholder="Digite para buscar colaborador..." oninput="filterColaboradores('colaborador-search', 'colaborador-list')" readonly>
                                      <div class="select-dropdown" id="colaborador-list">
                                          <div class="select-option" data-value="" onclick="selectColaborador('', 'Selecionar colaborador...', 'colaborador')">
                                              Selecionar colaborador...
                                          </div>
                                      </div>
                                  </div>
                                  <input type="hidden" id="colaborador" name="colaborador_id" value="" required>
                              </div>
                             
                             <div class="form-group">
                                 <label for="tipoAvaliacao">Tipo de Avaliação *</label>
                                 <select id="tipoAvaliacao" name="tipo_avaliacao" required>
                                     <option value="">Selecione o tipo...</option>
                                     <option value="45_dias">45 Dias</option>
                                     <option value="90_dias">90 Dias</option>
                                 </select>
                             </div>
                         </div>

                         <div class="form-row">
                             <div class="form-group">
                                 <label for="dataLimite">Data Limite *</label>
                                 <input type="datetime-local" id="dataLimite" name="data_limite" required>
                             </div>
                             
                             <div class="form-group">
                                 <label for="observacoes">Observações Iniciais</label>
                                 <textarea id="observacoes" name="observacoes_gestor" rows="3" placeholder="Observações iniciais do gestor..."></textarea>
                             </div>
                         </div>

                         <div class="form-group">
                             <button type="submit" class="btn btn-primary">
                                 <i class="fas fa-save"></i> Criar Avaliação com Template Padrão
                             </button>
                         </div>
                     </form>
                 </div>

                 <!-- Template Personalizado -->
                 <div id="template-personalizado" class="template-content" style="display: none !important;">
                     <div class="template-info">
                         <h4><i class="fas fa-edit"></i> Criar Avaliação Personalizada</h4>
                         <p>Crie suas próprias perguntas e categorias para avaliações específicas.</p>
                     </div>
                     
                     <form id="formAvaliacaoPersonalizada">
                                                   <div class="form-row">
                              <div class="form-group">
                                  <label for="colaboradorPersonalizado">Colaborador *</label>
                                  <div class="searchable-select">
                                      <input type="text" class="form-input" id="colaboradorPersonalizado-search" placeholder="Digite para buscar colaborador..." oninput="filterColaboradores('colaboradorPersonalizado-search', 'colaboradorPersonalizado-list')" readonly>
                                      <div class="select-dropdown" id="colaboradorPersonalizado-list">
                                          <div class="select-option" data-value="" onclick="selectColaborador('', 'Selecionar colaborador...', 'colaboradorPersonalizado')">
                                              Selecionar colaborador...
                                          </div>
                                      </div>
                                  </div>
                                  <input type="hidden" id="colaboradorPersonalizado" name="colaborador_id" value="" required>
                              </div>
                             
                             <div class="form-group">
                                 <label for="tipoAvaliacaoPersonalizado">Tipo de Avaliação *</label>
                                 <select id="tipoAvaliacaoPersonalizado" name="tipo_avaliacao" required>
                                     <option value="">Selecione o tipo...</option>
                                     <option value="45_dias">45 Dias</option>
                                     <option value="90_dias">90 Dias</option>
                                     <option value="personalizado">Personalizado</option>
                                 </select>
                             </div>
                         </div>

                         <div class="form-row">
                             <div class="form-group">
                                 <label for="dataLimitePersonalizado">Data Limite *</label>
                                 <input type="datetime-local" id="dataLimitePersonalizado" name="data_limite" required>
                             </div>
                             
                             <div class="form-group">
                                 <label for="observacoesPersonalizado">Observações Iniciais</label>
                                 <textarea id="observacoesPersonalizado" name="observacoes_gestor" rows="3" placeholder="Observações iniciais do gestor..."></textarea>
                             </div>
                         </div>

                         <div class="form-group">
                             <label for="tituloAvaliacao">Título da Avaliação *</label>
                             <input type="text" id="tituloAvaliacao" name="titulo" placeholder="Ex: Avaliação de Desempenho Trimestral" required>
                         </div>

                         <div class="form-group">
                             <label for="descricaoAvaliacao">Descrição da Avaliação</label>
                             <textarea id="descricaoAvaliacao" name="descricao" rows="3" placeholder="Descreva o objetivo desta avaliação..."></textarea>
                         </div>

                         <div class="form-group">
                             <button type="button" class="btn btn-outline-primary" onclick="adicionarPergunta()">
                                 <i class="fas fa-plus"></i> Adicionar Pergunta
                             </button>
                         </div>

                         <div id="perguntasContainer">
                             <!-- Perguntas personalizadas serão adicionadas aqui -->
                         </div>

                         <div class="form-group">
                             <button type="submit" class="btn btn-success">
                                 <i class="fas fa-save"></i> Criar Avaliação Personalizada
                             </button>
                         </div>
                     </form>
                 </div>

                <hr style="margin: 40px 0; border: 1px solid #e1e5e9;">

                <h2><i class="fas fa-list"></i> Avaliações Pendentes</h2>
                
                <div class="loading" id="loadingGestor">
                    <div class="spinner"></div>
                    <p>Carregando avaliações...</p>
                </div>

                <div id="avaliacoesGestor" class="avaliacoes-grid">
                    <!-- Avaliações serão carregadas aqui -->
                </div>
            </div>

            <!-- TAB COLABORADOR -->
            <div id="tab-colaborador" class="tab-content">
                <div class="error-message" id="errorMessageColaborador"></div>
                <div class="success-message" id="successMessageColaborador"></div>

                <h2><i class="fas fa-clipboard-check"></i> Minhas Avaliações</h2>
                
                <div class="loading" id="loadingColaborador">
                    <div class="spinner"></div>
                    <p>Carregando avaliações...</p>
                </div>

                <div id="avaliacoesColaborador" class="avaliacoes-grid">
                    <!-- Avaliações serão carregadas aqui -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let colaboradores = [];
        let avaliacoesGestor = [];
        let avaliacoesColaborador = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, inicializando sistema de avaliações...');
            console.log('Verificando elementos da página...');
            
            // Verificar se os elementos existem
            const templatePadrao = document.getElementById('template-padrao');
            const templatePersonalizado = document.getElementById('template-personalizado');
            const templateOptions = document.querySelector('.template-options');
            
            console.log('Template padrão:', templatePadrao);
            console.log('Template personalizado:', templatePersonalizado);
            console.log('Template options:', templateOptions);
            
            carregarColaboradores();
            carregarAvaliacoesGestor();
            carregarAvaliacoesColaborador();
            
            // Carregar colaboradores para ambos os formulários
            carregarColaboradoresPersonalizado();
            
            // Garantir que o template padrão seja exibido inicialmente
            
            if (templatePadrao) {
                templatePadrao.style.setProperty('display', 'block', 'important');
                console.log('Template padrão exibido');
            } else {
                console.error('Template padrão não encontrado');
            }
            
            if (templatePersonalizado) {
                templatePersonalizado.style.setProperty('display', 'none', 'important');
                console.log('Template personalizado escondido');
            } else {
                console.error('Template personalizado não encontrado');
            }
            
            // Forçar reflow e verificar se os templates estão visíveis
            setTimeout(() => {
                console.log('Verificando visibilidade dos templates...');
                console.log('Template padrão display:', templatePadrao ? getComputedStyle(templatePadrao).display : 'não encontrado');
                console.log('Template personalizado display:', templatePersonalizado ? getComputedStyle(templatePersonalizado).display : 'não encontrado');
                
                // Se o template padrão não estiver visível, forçar
                if (templatePadrao && getComputedStyle(templatePadrao).display === 'none') {
                    console.log('Forçando exibição do template padrão...');
                    templatePadrao.style.setProperty('display', 'block', 'important');
                }
                
                // Verificar se o template padrão está visível
                if (templatePadrao) {
                    const isVisible = getComputedStyle(templatePadrao).display !== 'none';
                    console.log('Template padrão está visível:', isVisible);
                    
                    if (!isVisible) {
                        console.log('Tentando corrigir visibilidade do template padrão...');
                        templatePadrao.style.setProperty('display', 'block', 'important');
                        templatePadrao.style.setProperty('opacity', '1', 'important');
                        templatePadrao.style.setProperty('visibility', 'visible', 'important');
                        templatePadrao.style.setProperty('position', 'relative', 'important');
                        templatePadrao.style.setProperty('z-index', '1', 'important');
                    }
                }
                
                // Verificar se o template personalizado está escondido
                if (templatePersonalizado) {
                    const isHidden = getComputedStyle(templatePersonalizado).display === 'none';
                    console.log('Template personalizado está escondido:', isHidden);
                    
                    if (!isHidden) {
                        console.log('Tentando esconder template personalizado...');
                        templatePersonalizado.style.setProperty('display', 'none', 'important');
                        templatePersonalizado.style.setProperty('opacity', '0', 'important');
                        templatePersonalizado.style.setProperty('visibility', 'hidden', 'important');
                        templatePersonalizado.style.setProperty('position', 'absolute', 'important');
                        templatePersonalizado.style.setProperty('z-index', '-1', 'important');
                    }
                }
            }, 100);
        });

        function showTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab selecionada
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Ativar a tab clicada
            const clickedTab = event.target.closest('.tab');
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
        }

        async function carregarColaboradores() {
            try {
                console.log('🔄 Carregando colaboradores reais do sistema...');
                
                // Buscar usuários reais da API do sistema
                const response = await fetch('/api/users/feedback');
                if (response.ok) {
                    const users = await response.json();
                    
                    // Converter para o formato esperado pelo sistema de avaliações
                    // Filtrar usuário atual (não pode avaliar a si mesmo)
                    const currentUserId = await getCurrentUserId();
                    colaboradores = users
                        .filter(user => !currentUserId || user.userId !== currentUserId) // Excluir usuário atual se disponível
                        .map(user => ({
                            id: user.userId,
                            nome: user.nomeCompleto,
                            departamento: user.departamento,
                            cargo: user.cargo
                        }));
                    
                    console.log(`✅ ${colaboradores.length} colaboradores carregados do sistema real`);
                    console.log('Primeiros colaboradores:', colaboradores.slice(0, 3));
                    
                    // Carregar colaboradores no select pesquisável após um delay
                    setTimeout(carregarColaboradoresSelect, 200);
                } else {
                    throw new Error(`API retornou status ${response.status}`);
                }
            } catch (error) {
                console.error('❌ Erro ao carregar colaboradores reais:', error);
                showError('Erro ao carregar colaboradores do sistema', 'gestor');
                
                // Fallback: tentar criar lista básica se a API falhar
                try {
                    console.log('🔄 Tentando fallback para lista básica...');
                    const fallbackResponse = await fetch('/api/users');
                    if (fallbackResponse.ok) {
                        const fallbackUsers = await fallbackResponse.json();
                        colaboradores = fallbackUsers.map(user => ({
                            id: user.Id || user.id,
                            nome: user.NomeCompleto || user.nome || 'Nome não informado',
                            departamento: user.Departamento || user.departamento || 'Departamento não informado'
                        }));
                        console.log(`✅ ${colaboradores.length} colaboradores carregados do fallback`);
                        setTimeout(carregarColaboradoresSelect, 200);
                    }
                } catch (fallbackError) {
                    console.error('❌ Fallback também falhou:', fallbackError);
                    showError('Não foi possível carregar colaboradores do sistema', 'gestor');
                }
            }
        }

        async function carregarAvaliacoesGestor() {
            try {
                document.getElementById('loadingGestor').style.display = 'block';
                
                const response = await fetch('/api/avaliacoes/gestor');
                avaliacoesGestor = await response.json();
                
                renderizarAvaliacoesGestor();
            } catch (error) {
                console.error('Erro ao carregar avaliações:', error);
                showError('Erro ao carregar avaliações', 'gestor');
            } finally {
                document.getElementById('loadingGestor').style.display = 'none';
            }
        }

        async function carregarAvaliacoesColaborador() {
            try {
                document.getElementById('loadingColaborador').style.display = 'block';
                
                const response = await fetch('/api/avaliacoes/colaborador');
                avaliacoesColaborador = await response.json();
                
                renderizarAvaliacoesColaborador();
            } catch (error) {
                console.error('Erro ao carregar avaliações:', error);
                showError('Erro ao carregar avaliações', 'colaborador');
            } finally {
                document.getElementById('loadingColaborador').style.display = 'none';
            }
        }

        function renderizarAvaliacoesGestor() {
            const container = document.getElementById('avaliacoesGestor');
            
            if (avaliacoesGestor.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Nenhuma avaliação encontrada</h3>
                        <p>Crie uma nova avaliação para começar</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = avaliacoesGestor.map(avaliacao => `
                <div class="avaliacao-card">
                    <div class="avaliacao-header">
                        <span class="avaliacao-tipo">${avaliacao.tipo_avaliacao === '45_dias' ? '45 Dias' : '90 Dias'}</span>
                        <span class="avaliacao-status status-${avaliacao.status.toLowerCase()}">${getStatusText(avaliacao.status)}</span>
                    </div>
                    
                    <div class="avaliacao-info">
                        <h4>${getColaboradorNome(avaliacao.colaborador_id)}</h4>
                        <p><strong>Data Limite:</strong> ${formatarData(avaliacao.data_limite)}</p>
                        <p><strong>Criada em:</strong> ${formatarData(avaliacao.data_criacao)}</p>
                        ${avaliacao.observacoes_gestor ? `<p><strong>Observações:</strong> ${avaliacao.observacoes_gestor}</p>` : ''}
                    </div>
                    
                    <div class="avaliacao-actions">
                        ${avaliacao.status === 'Pendente' ? `
                            <button class="btn btn-warning btn-small" onclick="enviarLembrete(${avaliacao.id})">
                                <i class="fas fa-bell"></i> Lembrete
                            </button>
                        ` : ''}
                        
                        ${avaliacao.status === 'Autoavaliacao_Concluida' ? `
                            <button class="btn btn-primary btn-small" onclick="realizarAvaliacao(${avaliacao.id})">
                                <i class="fas fa-edit"></i> Avaliar
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-secondary btn-small" onclick="verDetalhes(${avaliacao.id})">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderizarAvaliacoesColaborador() {
            const container = document.getElementById('avaliacoesColaborador');
            
            if (avaliacoesColaborador.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Nenhuma avaliação pendente</h3>
                        <p>Você não possui avaliações para responder no momento</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = avaliacoesColaborador.map(avaliacao => `
                <div class="avaliacao-card">
                    <div class="avaliacao-header">
                        <span class="avaliacao-tipo">${avaliacao.tipo_avaliacao === '45_dias' ? '45 Dias' : '90 Dias'}</span>
                        <span class="avaliacao-status status-${avaliacao.status.toLowerCase()}">${getStatusText(avaliacao.status)}</span>
                    </div>
                    
                    <div class="avaliacao-info">
                        <h4>Avaliação de ${avaliacao.tipo_avaliacao === '45_dias' ? '45' : '90'} dias</h4>
                        <p><strong>Data Limite:</strong> ${formatarData(avaliacao.data_limite)}</p>
                        <p><strong>Criada em:</strong> ${formatarData(avaliacao.data_criacao)}</p>
                        ${avaliacao.observacoes_gestor ? `<p><strong>Observações:</strong> ${avaliacao.observacoes_gestor}</p>` : ''}
                    </div>
                    
                    <div class="avaliacao-actions">
                        ${avaliacao.status === 'Pendente' ? `
                            <button class="btn btn-primary btn-small" onclick="realizarAutoavaliacao(${avaliacao.id})">
                                <i class="fas fa-edit"></i> Autoavaliação
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-secondary btn-small" onclick="verDetalhes(${avaliacao.id})">
                            <i class="fas fa-eye"></i> Detalhes
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Função de teste para verificar templates
        function testarTemplates() {
            console.log('=== TESTE DE TEMPLATES ===');
            
            const templatePadrao = document.getElementById('template-padrao');
            const templatePersonalizado = document.getElementById('template-personalizado');
            
            console.log('Template padrão encontrado:', !!templatePadrao);
            console.log('Template personalizado encontrado:', !!templatePersonalizado);
            
            if (templatePadrao) {
                console.log('Template padrão display:', getComputedStyle(templatePadrao).display);
                console.log('Template padrão visibility:', getComputedStyle(templatePadrao).visibility);
                console.log('Template padrão opacity:', getComputedStyle(templatePadrao).opacity);
                console.log('Template padrão position:', getComputedStyle(templatePadrao).position);
                console.log('Template padrão z-index:', getComputedStyle(templatePadrao).zIndex);
            }
            
            if (templatePersonalizado) {
                console.log('Template personalizado display:', getComputedStyle(templatePersonalizado).display);
                console.log('Template personalizado visibility:', getComputedStyle(templatePersonalizado).visibility);
                console.log('Template personalizado opacity:', getComputedStyle(templatePersonalizado).opacity);
                console.log('Template personalizado position:', getComputedStyle(templatePersonalizado).position);
                console.log('Template personalizado z-index:', getComputedStyle(templatePersonalizado).zIndex);
            }
            
            // Testar se os templates estão funcionando
            console.log('Testando seleção de templates...');
            selecionarTemplate('padrao', { target: document.querySelector('.btn-outline-primary') });
            
            setTimeout(() => {
                console.log('Verificando após seleção...');
                if (templatePadrao) {
                    console.log('Template padrão display após seleção:', getComputedStyle(templatePadrao).display);
                    console.log('Template padrão visibility após seleção:', getComputedStyle(templatePadrao).visibility);
                    console.log('Template padrão opacity após seleção:', getComputedStyle(templatePadrao).opacity);
                    console.log('Template padrão position após seleção:', getComputedStyle(templatePadrao).position);
                    console.log('Template padrão z-index após seleção:', getComputedStyle(templatePadrao).zIndex);
                }
            }, 100);
            
            // Testar também o template personalizado
            setTimeout(() => {
                console.log('Testando template personalizado...');
                selecionarTemplate('personalizado', { target: document.querySelector('.btn-outline-secondary') });
                
                setTimeout(() => {
                    console.log('Verificando template personalizado após seleção...');
                    if (templatePersonalizado) {
                        console.log('Template personalizado display após seleção:', getComputedStyle(templatePersonalizado).display);
                        console.log('Template personalizado visibility após seleção:', getComputedStyle(templatePersonalizado).visibility);
                        console.log('Template personalizado opacity após seleção:', getComputedStyle(templatePersonalizado).opacity);
                        console.log('Template personalizado position após seleção:', getComputedStyle(templatePersonalizado).position);
                        console.log('Template personalizado z-index após seleção:', getComputedStyle(templatePersonalizado).zIndex);
                    }
                }, 100);
            }, 300);
            
            console.log('=== FIM DO TESTE ===');
        }
        
        // Funções para gerenciar templates
        function selecionarTemplate(tipo, event) {
            console.log('Selecionando template:', tipo);
            
            // Esconder todos os templates
            document.querySelectorAll('.template-content').forEach(template => {
                if (tipo === 'padrao') {
                    template.style.setProperty('display', 'none', 'important');
                    template.style.setProperty('opacity', '0', 'important');
                    template.style.setProperty('visibility', 'hidden', 'important');
                    template.style.setProperty('position', 'absolute', 'important');
                    template.style.setProperty('z-index', '-1', 'important');
                } else {
                    template.style.setProperty('display', 'none', 'important');
                    template.style.setProperty('opacity', '0', 'important');
                    template.style.setProperty('visibility', 'hidden', 'important');
                    template.style.setProperty('position', 'absolute', 'important');
                    template.style.setProperty('z-index', '-1', 'important');
                }
                console.log('Escondendo template:', template.id);
            });
            
            // Remover classe active de todos os botões
            document.querySelectorAll('.template-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar template selecionado
            const templateSelecionado = document.getElementById(`template-${tipo}`);
            if (templateSelecionado) {
                if (tipo === 'padrao') {
                    templateSelecionado.style.setProperty('display', 'block', 'important');
                    templateSelecionado.style.setProperty('opacity', '1', 'important');
                    templateSelecionado.style.setProperty('visibility', 'visible', 'important');
                    templateSelecionado.style.setProperty('position', 'relative', 'important');
                    templateSelecionado.style.setProperty('z-index', '1', 'important');
                } else {
                    templateSelecionado.style.setProperty('display', 'block', 'important');
                    templateSelecionado.style.setProperty('opacity', '1', 'important');
                    templateSelecionado.style.setProperty('visibility', 'visible', 'important');
                    templateSelecionado.style.setProperty('position', 'relative', 'important');
                    templateSelecionado.style.setProperty('z-index', '1', 'important');
                }
                console.log('Mostrando template:', templateSelecionado.id);
                
                // Forçar reflow
                templateSelecionado.offsetHeight;
            } else {
                console.error('Template não encontrado:', `template-${tipo}`);
            }
            
            // Ativar botão selecionado
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Verificar se funcionou
            setTimeout(() => {
                console.log('Verificando se a mudança funcionou...');
                console.log('Template selecionado display:', getComputedStyle(templateSelecionado).display);
            }, 50);
        }

        function adicionarPergunta() {
            const container = document.getElementById('perguntasContainer');
            const perguntaNum = container.children.length + 1;
            
            const perguntaDiv = document.createElement('div');
            perguntaDiv.className = 'pergunta-item';
            perguntaDiv.innerHTML = `
                <div class="pergunta-header">
                    <span class="pergunta-numero">Pergunta ${perguntaNum}</span>
                    <button type="button" class="remover-pergunta" onclick="removerPergunta(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="categoria_${perguntaNum}">Categoria *</label>
                        <input type="text" id="categoria_${perguntaNum}" name="categoria_${perguntaNum}" placeholder="Ex: Integração, Adaptação, Valores..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo_${perguntaNum}">Tipo de Resposta *</label>
                        <select id="tipo_${perguntaNum}" name="tipo_${perguntaNum}" required>
                            <option value="">Selecione o tipo...</option>
                            <option value="escala">Escala (1-10)</option>
                            <option value="texto">Texto livre</option>
                            <option value="sim_nao">Sim/Não</option>
                            <option value="multipla_escolha">Múltipla escolha</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="pergunta_${perguntaNum}">Pergunta *</label>
                    <textarea id="pergunta_${perguntaNum}" name="pergunta_${perguntaNum}" rows="3" placeholder="Digite a pergunta..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="ordem_${perguntaNum}">Ordem</label>
                    <input type="number" id="ordem_${perguntaNum}" name="ordem_${perguntaNum}" value="${perguntaNum}" min="1">
                </div>
            `;
            
            container.appendChild(perguntaDiv);
        }

        function removerPergunta(button) {
            button.closest('.pergunta-item').remove();
            // Renumerar perguntas restantes
            const perguntas = document.querySelectorAll('.pergunta-item');
            perguntas.forEach((pergunta, index) => {
                const numero = pergunta.querySelector('.pergunta-numero');
                numero.textContent = `Pergunta ${index + 1}`;
                
                const ordem = pergunta.querySelector('input[name^="ordem_"]');
                if (ordem) ordem.value = index + 1;
            });
        }

        async function carregarColaboradoresPersonalizado() {
            try {
                // Esta função não é mais necessária pois os colaboradores são carregados
                // automaticamente na função carregarColaboradoresSelect()
                // Mantida para compatibilidade
            } catch (error) {
                console.error('Erro ao carregar colaboradores para avaliação personalizada:', error);
            }
        }

        // Formulário de criação de avaliação com template padrão
        document.getElementById('formCriarAvaliacao').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                colaborador_id: parseInt(formData.get('colaborador_id')),
                tipo_avaliacao: formData.get('tipo_avaliacao'),
                data_limite: formData.get('data_limite'),
                observacoes_gestor: formData.get('observacoes_gestor'),
                template: 'padrao', // Indica que é o template padrão
                perguntas: templateAtual // Usar o template atual (editado ou original)
            };
            
            try {
                // Se o template foi editado, usar a rota de avaliação personalizada
                const url = templateAtual !== templatePadraoOriginal ? '/api/avaliacoes/personalizada' : '/api/avaliacoes';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const mensagem = templateAtual !== templatePadraoOriginal 
                        ? 'Avaliação criada com sucesso usando o template editado!' 
                        : 'Avaliação criada com sucesso usando o template padrão!';
                    showSuccess(mensagem, 'gestor');
                    this.reset();
                    carregarAvaliacoesGestor();
                } else {
                    showError('Erro ao criar avaliação: ' + result.error, 'gestor');
                }
            } catch (error) {
                console.error('Erro ao criar avaliação:', error);
                showError('Erro ao criar avaliação', 'gestor');
            }
        });

        // Formulário de criação de avaliação personalizada
        document.getElementById('formAvaliacaoPersonalizada').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                colaborador_id: parseInt(formData.get('colaborador_id')),
                tipo_avaliacao: formData.get('tipo_avaliacao'),
                data_limite: formData.get('data_limite'),
                observacoes_gestor: formData.get('observacoes_gestor'),
                titulo: formData.get('titulo'),
                descricao: formData.get('descricao'),
                template: 'personalizado',
                perguntas: []
            };
            
            // Coletar perguntas personalizadas
            const perguntas = document.querySelectorAll('.pergunta-item');
            perguntas.forEach((pergunta, index) => {
                const categoria = pergunta.querySelector('input[name^="categoria_"]').value;
                const tipo = pergunta.querySelector('select[name^="tipo_"]').value;
                const perguntaTexto = pergunta.querySelector('textarea[name^="pergunta_"]').value;
                const ordem = pergunta.querySelector('input[name^="ordem_"]').value;
                
                if (categoria && tipo && perguntaTexto) {
                    data.perguntas.push({
                        categoria: categoria,
                        tipo: tipo,
                        pergunta: perguntaTexto,
                        ordem: parseInt(ordem)
                    });
                }
            });
            
            if (data.perguntas.length === 0) {
                showError('Adicione pelo menos uma pergunta para criar a avaliação personalizada', 'gestor');
                return;
            }
            
            try {
                const response = await fetch('/api/avaliacoes/personalizada', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Avaliação personalizada criada com sucesso!', 'gestor');
                    this.reset();
                    document.getElementById('perguntasContainer').innerHTML = '';
                    carregarAvaliacoesGestor();
                } else {
                    showError('Erro ao criar avaliação personalizada: ' + result.error, 'gestor');
                }
            } catch (error) {
                console.error('Erro ao criar avaliação personalizada:', error);
                showError('Erro ao criar avaliação personalizada', 'gestor');
            }
        });

        // Funções auxiliares
        function getStatusText(status) {
            const statusMap = {
                'Pendente': 'Pendente',
                'Autoavaliacao_Concluida': 'Autoavaliação Concluída',
                'Concluida': 'Concluída'
            };
            return statusMap[status] || status;
        }

        function getColaboradorNome(id) {
            const colaborador = colaboradores.find(c => c.id === id);
            if (!colaborador) return 'Colaborador não encontrado';
            
            // Retornar nome com departamento se disponível
            return colaborador.departamento ? 
                `${colaborador.nome} - ${colaborador.departamento}` : 
                colaborador.nome;
        }

        function formatarData(dataString) {
            if (!dataString) return 'N/A';
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
        }

        function showError(message, tab) {
            const errorDiv = document.getElementById(`errorMessage${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            const successDiv = document.getElementById(`successMessage${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            successDiv.style.display = 'none';
        }

        function showSuccess(message, tab) {
            const successDiv = document.getElementById(`successMessage${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            const errorDiv = document.getElementById(`errorMessage${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            errorDiv.style.display = 'none';
        }

        // Funções das ações (serão implementadas)
        function enviarLembrete(avaliacaoId) {
            showSuccess('Lembrete enviado com sucesso!', 'gestor');
        }

        function realizarAvaliacao(avaliacaoId) {
            // Abrir modal ou página de avaliação
            showSuccess('Redirecionando para avaliação...', 'gestor');
        }

        function realizarAutoavaliacao(avaliacaoId) {
            // Abrir modal ou página de autoavaliação
            showSuccess('Redirecionando para autoavaliação...', 'colaborador');
        }

        function verDetalhes(avaliacaoId) {
            // Abrir modal ou página de detalhes
            showSuccess('Carregando detalhes...', 'gestor');
        }
        
        // Função para mostrar/ocultar as perguntas do template padrão
        function mostrarPerguntasTemplate() {
            const previewDiv = document.getElementById('perguntasTemplatePreview');
            const button = event.target;
            
            if (previewDiv.style.display === 'none') {
                previewDiv.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar Perguntas do Template';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-outline-secondary');
            } else {
                previewDiv.style.display = 'none';
                button.innerHTML = '<i class="fas fa-eye"></i> Ver Perguntas do Template';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-primary');
            }
        }
        
        // Template padrão original (para restaurar se necessário)
        const templatePadraoOriginal = [
            {
                categoria: 'Integração',
                texto: 'É acessível e acolhedor com todas as pessoas, tratando a todos com respeito e cordialidade.',
                tipo: 'escala'
            },
            {
                categoria: 'Adaptação',
                texto: 'É pontual no cumprimento de sua jornada de trabalho (faltas, atrasos ou saídas antecipadas).',
                tipo: 'escala'
            },
            {
                categoria: 'Adaptação',
                texto: 'Identifica oportunidades que contribuam para o desenvolvimento do Setor.',
                tipo: 'escala'
            },
            {
                categoria: 'Adaptação',
                texto: 'Mantém a calma frente a diversidade do ambiente e à novos desafios, buscando interagir de forma adequada às mudanças.',
                tipo: 'escala'
            },
            {
                categoria: 'Valores',
                texto: 'É respeitoso com as pessoas contribuindo com um ambiente de trabalho saudável.',
                tipo: 'escala'
            },
            {
                categoria: 'Valores',
                texto: 'Tem caráter inquestionável, age com honestidade e integridade no relacionamento com gestores, colegas, prestadores de serviço, fornecedores e demais profissionais que venha a ter contato na empresa.',
                tipo: 'escala'
            },
            {
                categoria: 'Valores',
                texto: 'Exerce suas atividades com transparência e estrita observância às leis, aos princípios e as diretrizes da empresa.',
                tipo: 'escala'
            },
            {
                categoria: 'Orientação para resultados',
                texto: 'Mantém a produtividade e a motivação diante de situações sobre pressão.',
                tipo: 'escala'
            },
            {
                categoria: 'Orientação para resultados',
                texto: 'Age com engajamento para atingir os objetivos e metas.',
                tipo: 'escala'
            },
            {
                categoria: 'Orientação para resultados',
                texto: 'Capacidade para concretizar as tarefas que lhe são solicitadas, com o alcance de objetivos e de forma comprometida com o resultado de seu Setor.',
                tipo: 'escala'
            }
        ];
        
        // Template atual (pode ser editado)
        let templateAtual = JSON.parse(JSON.stringify(templatePadraoOriginal));
        
        // Função para editar o template padrão
        function editarTemplatePadrao() {
            const previewDiv = document.getElementById('perguntasTemplatePreview');
            const editorDiv = document.getElementById('editorTemplatePadrao');
            const editButton = event.target;
            
            // Esconder a prévia e mostrar o editor
            previewDiv.style.display = 'none';
            editorDiv.style.display = 'block';
            
            // Alterar o botão de editar
            editButton.innerHTML = '<i class="fas fa-eye"></i> Ver Template';
            editButton.classList.remove('btn-outline-warning');
            editButton.classList.add('btn-outline-primary');
            editButton.onclick = mostrarTemplateEditado;
            
            // Carregar as perguntas editáveis
            carregarPerguntasEditaveis();
        }
        
        // Função para mostrar o template editado
        function mostrarTemplateEditado() {
            const previewDiv = document.getElementById('perguntasTemplatePreview');
            const editorDiv = document.getElementById('editorTemplatePadrao');
            const editButton = event.target;
            
            // Esconder o editor e mostrar a prévia
            editorDiv.style.display = 'none';
            previewDiv.style.display = 'block';
            
            // Restaurar o botão de editar
            editButton.innerHTML = '<i class="fas fa-edit"></i> Editar Template';
            editButton.classList.remove('btn-outline-primary');
            editButton.classList.add('btn-outline-warning');
            editButton.onclick = editarTemplatePadrao;
            
            // Atualizar a prévia com as perguntas editadas
            atualizarPreviaTemplate();
        }
        
        // Função para carregar as perguntas editáveis
        function carregarPerguntasEditaveis() {
            const container = document.getElementById('perguntasEditaveis');
            container.innerHTML = '';
            
            templateAtual.forEach((pergunta, index) => {
                const perguntaDiv = document.createElement('div');
                perguntaDiv.className = 'pergunta-editavel';
                perguntaDiv.innerHTML = `
                    <div class="pergunta-editavel-header">
                        <span class="pergunta-editavel-numero">${index + 1}</span>
                        <span class="pergunta-editavel-categoria">${pergunta.categoria}</span>
                    </div>
                    <textarea 
                        class="pergunta-editavel-texto" 
                        data-index="${index}"
                        placeholder="Digite a pergunta..."
                    >${pergunta.texto}</textarea>
                `;
                
                // Adicionar evento para salvar automaticamente as mudanças
                const textarea = perguntaDiv.querySelector('textarea');
                textarea.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    templateAtual[index].texto = this.value;
                });
                
                container.appendChild(perguntaDiv);
            });
        }
        
        // Função para atualizar a prévia do template
        function atualizarPreviaTemplate() {
            const previewDiv = document.getElementById('perguntasTemplatePreview');
            
            // Atualizar as perguntas na prévia
            const perguntasItems = previewDiv.querySelectorAll('.pergunta-item .pergunta-texto');
            templateAtual.forEach((pergunta, index) => {
                if (perguntasItems[index]) {
                    perguntasItems[index].textContent = pergunta.texto;
                }
            });
            
            // Atualizar o status visual do template
            atualizarStatusTemplate();
        }
        
        // Função para atualizar o status visual do template
        function atualizarStatusTemplate() {
            const statusElement = document.getElementById('templateStatus');
            const isEditado = templateAtual !== templatePadraoOriginal;
            
            if (isEditado) {
                statusElement.textContent = 'Editado';
                statusElement.className = 'template-status editado';
            } else {
                statusElement.textContent = 'Original';
                statusElement.className = 'template-status';
            }
        }
        
        // Função para salvar o template editado
        function salvarTemplateEditado() {
            // Validar se todas as perguntas têm texto
            const perguntasVazias = templateAtual.filter(p => !p.texto.trim());
            if (perguntasVazias.length > 0) {
                alert('Todas as perguntas devem ter texto. Verifique as perguntas vazias.');
                return;
            }
            
            // Salvar o template editado
            localStorage.setItem('templatePadraoEditado', JSON.stringify(templateAtual));
            
            // Mostrar mensagem de sucesso
            showSuccess('Template editado salvo com sucesso!', 'gestor');
            
            // Voltar para a visualização
            mostrarTemplateEditado();
        }
        
        // Função para cancelar a edição do template
        function cancelarEdicaoTemplate() {
            // Restaurar o template original
            templateAtual = JSON.parse(JSON.stringify(templatePadraoOriginal));
            
            // Voltar para a visualização
            mostrarTemplateEditado();
            
            showSuccess('Edição cancelada. Template restaurado ao original.', 'gestor');
        }
        
        // Função para carregar template salvo ao inicializar
        function carregarTemplateSalvo() {
            const templateSalvo = localStorage.getItem('templatePadraoEditado');
            if (templateSalvo) {
                try {
                    templateAtual = JSON.parse(templateSalvo);
                    console.log('Template editado carregado do localStorage');
                } catch (error) {
                    console.error('Erro ao carregar template salvo:', error);
                    templateAtual = JSON.parse(JSON.stringify(templatePadraoOriginal));
                }
            }
        }
        
        // Função para restaurar o template original
        function restaurarTemplateOriginal() {
            if (confirm('Tem certeza que deseja restaurar o template original? Todas as edições serão perdidas.')) {
                // Restaurar o template original
                templateAtual = JSON.parse(JSON.stringify(templatePadraoOriginal));
                
                // Remover do localStorage
                localStorage.removeItem('templatePadraoEditado');
                
                // Atualizar a prévia
                atualizarPreviaTemplate();
                
                showSuccess('Template original restaurado com sucesso!', 'gestor');
            }
        }
        
        // Carregar template salvo quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            carregarTemplateSalvo();
            // Atualizar o status visual após carregar
            setTimeout(atualizarStatusTemplate, 100);
            
            // Configurar eventos para os selects pesquisáveis
            configurarSelectsPesquisaveis();
        });
        
        // Função para obter ID do usuário atual
        async function getCurrentUserId() {
            // Tentar obter do localStorage ou sessionStorage
            const storedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    return user.userId || user.id;
                } catch (e) {
                    console.log('Erro ao parsear usuário armazenado:', e);
                }
            }
            
            // Tentar obter da API do sistema
            try {
                const response = await fetch('/api/usuario');
                if (response.ok) {
                    const currentUser = await response.json();
                    console.log('✅ Usuário atual obtido da API:', currentUser);
                    return currentUser.userId || currentUser.id;
                }
            } catch (error) {
                console.log('API de usuário atual não disponível:', error);
            }
            
            // Fallback: retornar null para não filtrar
            console.log('⚠️ Usuário atual não encontrado, mostrando todos os colaboradores');
            return null;
        }
        
        // Funções para o select pesquisável
        function configurarSelectsPesquisaveis() {
            // Configurar o select de colaborador principal
            const colaboradorSearch = document.getElementById('colaborador-search');
            const colaboradorList = document.getElementById('colaborador-list');
            
            // Configurar o select de colaborador personalizado
            const colaboradorPersonalizadoSearch = document.getElementById('colaboradorPersonalizado-search');
            const colaboradorPersonalizadoList = document.getElementById('colaboradorPersonalizado-list');
            
            // Verificar se os elementos existem
            if (!colaboradorSearch || !colaboradorList || !colaboradorPersonalizadoSearch || !colaboradorPersonalizadoList) {
                console.log('Elementos do select pesquisável ainda não foram criados, tentando novamente em 100ms...');
                setTimeout(configurarSelectsPesquisaveis, 100);
                return;
            }
            
            // Eventos para o select principal
            colaboradorSearch.addEventListener('click', function() {
                colaboradorList.classList.toggle('show');
                this.readOnly = false;
                this.focus();
            });
            
            colaboradorSearch.addEventListener('blur', function() {
                setTimeout(() => {
                    colaboradorList.classList.remove('show');
                    this.readOnly = true;
                }, 200);
            });
            
            // Eventos para o select personalizado
            colaboradorPersonalizadoSearch.addEventListener('click', function() {
                colaboradorPersonalizadoList.classList.toggle('show');
                this.readOnly = false;
                this.focus();
            });
            
            colaboradorPersonalizadoSearch.addEventListener('blur', function() {
                setTimeout(() => {
                    colaboradorPersonalizadoList.classList.remove('show');
                    this.readOnly = true;
                }, 200);
            });
            
            // Fechar dropdowns quando clicar fora
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.searchable-select')) {
                    colaboradorList.classList.remove('show');
                    colaboradorPersonalizadoList.classList.remove('show');
                    colaboradorSearch.readOnly = true;
                    colaboradorPersonalizadoSearch.readOnly = true;
                }
            });
        }
        
        // Função para filtrar colaboradores
        function filterColaboradores(searchId, listId) {
            const searchInput = document.getElementById(searchId);
            const dropdownList = document.getElementById(listId);
            
            // Verificar se os elementos existem
            if (!searchInput || !dropdownList) {
                console.error('Elementos não encontrados para filtrar colaboradores');
                return;
            }
            
            const searchTerm = searchInput.value.toLowerCase();
            
            // Mostrar dropdown
            dropdownList.classList.add('show');
            
            // Filtrar opções
            const options = dropdownList.querySelectorAll('.select-option');
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm) || searchTerm === '') {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            });
        }
        
        // Função para selecionar colaborador
        function selectColaborador(value, text, fieldId) {
            const searchInput = document.getElementById(fieldId + '-search');
            const hiddenInput = document.getElementById(fieldId);
            const dropdownList = document.getElementById(fieldId + '-list');
            
            // Verificar se os elementos existem
            if (!searchInput || !hiddenInput || !dropdownList) {
                console.error('Elementos não encontrados para:', fieldId);
                return;
            }
            
            // Atualizar campos
            searchInput.value = text;
            hiddenInput.value = value;
            
            // Fechar dropdown
            dropdownList.classList.remove('show');
            searchInput.readOnly = true;
            
            // Marcar opção selecionada
            const options = dropdownList.querySelectorAll('.select-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.value === value) {
                    option.classList.add('selected');
                }
            });
            
            console.log('Colaborador selecionado:', { fieldId, value, text });
        }
        
        // Função para carregar colaboradores no select pesquisável
        function carregarColaboradoresSelect() {
            const colaboradorList = document.getElementById('colaborador-list');
            const colaboradorPersonalizadoList = document.getElementById('colaboradorPersonalizado-list');
            
            // Verificar se os elementos existem
            if (!colaboradorList || !colaboradorPersonalizadoList) {
                console.log('Elementos do select pesquisável ainda não foram criados');
                return;
            }
            
            // Verificar se colaboradores foram carregados
            if (!colaboradores || colaboradores.length === 0) {
                console.log('Lista de colaboradores ainda não foi carregada');
                return;
            }
            
            // Limpar listas existentes (mantendo a opção padrão)
            colaboradorList.innerHTML = '<div class="select-option" data-value="" onclick="selectColaborador(\'\', \'Selecionar colaborador...\', \'colaborador\')">Selecionar colaborador...</div>';
            colaboradorPersonalizadoList.innerHTML = '<div class="select-option" data-value="" onclick="selectColaborador(\'\', \'Selecionar colaborador...\', \'colaboradorPersonalizado\')">Selecionar colaborador...</div>';
            
            // Adicionar colaboradores
            colaboradores.forEach(colab => {
                // Criar texto de exibição com nome e departamento
                const displayText = colab.departamento ? 
                    `${colab.nome} - ${colab.departamento}` : 
                    colab.nome;
                
                const option1 = document.createElement('div');
                option1.className = 'select-option';
                option1.dataset.value = colab.id;
                option1.onclick = () => selectColaborador(colab.id, displayText, 'colaborador');
                option1.textContent = displayText;
                colaboradorList.appendChild(option1);
                
                const option2 = document.createElement('div');
                option2.className = 'select-option';
                option2.dataset.value = colab.id;
                option2.onclick = () => selectColaborador(colab.id, displayText, 'colaboradorPersonalizado');
                option2.textContent = displayText;
                colaboradorPersonalizadoList.appendChild(option2);
            });
            
            console.log('Colaboradores carregados no select pesquisável:', colaboradores.length);
        }
    </script>
</body>
</html>
